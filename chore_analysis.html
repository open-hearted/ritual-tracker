<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Chore Planner: ä¾å­˜é–¢ä¿‚ã§è©°ã¾ã‚Šã‚’ã»ã©ã</title>
  <style>
    :root {
      --bg:#0b1220; --card:#0f172a; --muted:#334155; --text:#e5e7eb;
      --ok:#34d399; --warn:#fbbf24; --accent:#22d3ee; --danger:#f87171;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP"}
    header{position:sticky;top:0;z-index:9;background:rgba(11,18,32,.85);backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.2);padding:12px 16px}
    header h1{margin:0;font-size:18px}
    .wrap{max-width:860px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.18);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .section{margin-top:14px}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    label{font-size:12px;color:#cbd5e1}
    input[type=text],select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.2);background:#0b1220;color:var(--text);font-size:15px}
    textarea{min-height:68px;resize:vertical}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 12px;font-weight:700;font-size:15px;cursor:pointer;color:#07131c;background:#e2e8f0}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,#22d3ee,#a78bfa)}
    .btn.muted{background:#1f2937;color:#e5e7eb;border:1px solid rgba(148,163,184,.18)}
    .btn.danger{background:linear-gradient(135deg,#fecaca,#fda4af)}
    .stack{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-bottom:1px dashed rgba(148,163,184,.18)}
    .row:last-child{border-bottom:0}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;color:#06131a}
    .b-action{background:#bae6fd}
    .b-resource{background:#fde68a}
    .status{font-size:12px;color:#9ca3af}
    .why{font-size:13px;color:#e5e7eb}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:6px 10px;font-size:12px}
    .list{list-style:none;margin:0;padding:0}
    .hint{font-size:12px;color:#9ca3af}
    .toast{position:fixed;left:12px;right:12px;bottom:14px;display:none;background:#0b1220;border:1px solid rgba(148,163,184,.25);padding:14px 16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .toast.show{display:block}
    .sep{height:1px;background:rgba(148,163,184,.18);margin:10px 0}
    .mini{font-size:12px;color:#cbd5e1}
    .testlog{font-size:12px;white-space:pre-wrap;background:#0b1220;border:1px solid rgba(148,163,184,.2);padding:8px;border-radius:10px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <h1>å®¶äº‹ãƒ‡ãƒ—ã‚¹ï¼šä¾å­˜é–¢ä¿‚ã§æ¬¡ã®ä¸€æ‰‹ã‚’å‡ºã™</h1>
    <div class="mini">ç›®çš„ï¼ˆWhyï¼‰ã¨ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼ˆBlocked byï¼‰ã§æ•´ç†ã—ã€"ã„ã¾å‡ºæ¥ã‚‹æœ€å°ã®ä¸€æ‰‹" ã‚’æç¤ºã—ã¾ã™ã€‚</div>
  </header>

  <div class="wrap">
    <!-- Quick Templates (Laundry chain) -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:800">ã‚¯ã‚¤ãƒƒã‚¯ä½œæˆï¼šæ´—æ¿¯ãƒ•ãƒ­ãƒ¼ä¾‹</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn danger" id="resetBtn" title="ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¨ç”»é¢ã‚’åˆæœŸåŒ–">åˆæœŸåŒ–</button>
          <button class="btn muted" id="runTestsBtn" title="é–‹ç™ºè€…ãƒ†ã‚¹ãƒˆ">ãƒ†ã‚¹ãƒˆ</button>
          <button class="btn muted" id="annoyBtn">ã‚ã‚“ã©ãã•ã„ğŸ˜µâ€ğŸ’«</button>
        </div>
      </div>
      <div class="grid cols-3 section">
        <button class="btn" id="templateLaundry">æ´—æ¿¯ã®è©°ã¾ã‚Šã‚’å±•é–‹</button>
        <button class="btn" id="templateCloset">ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆæ•´é “ã‚’å±•é–‹</button>
        <button class="btn" id="templateHangers">ãƒãƒ³ã‚¬ãƒ¼ã‚’ç”¨æ„ã‚’å±•é–‹</button>
      </div>
      <div class="hint">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ä¾å­˜é–¢ä¿‚ã¤ãã§ä¸€å¼ç™»éŒ²ã—ã¾ã™ï¼ˆç·¨é›†å¯ï¼‰ã€‚</div>
      <div id="testOutput" class="testlog" style="display:none"></div>
    </div>

    <!-- Create Task -->
    <div class="card section">
      <div style="font-weight:800">ã‚¿ã‚¹ã‚¯/ãƒªã‚½ãƒ¼ã‚¹ã®è¿½åŠ </div>
      <div class="grid cols-2 section">
        <div class="stack">
          <div>
            <label>ç¨®åˆ¥</label>
            <select id="kind">
              <option value="action">ğŸ§© ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¡Œå‹•ï¼‰</option>
              <option value="resource">ğŸ“¦ ãƒªã‚½ãƒ¼ã‚¹ï¼ˆç‰©ãƒ»å ´æ‰€ãƒ»çŠ¶æ…‹ï¼‰</option>
            </select>
          </div>
          <div>
            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input id="title" type="text" placeholder="ä¾‹ï¼šæ´—æ¿¯ã™ã‚‹ / ä¹¾ã‹ã™å ´æ‰€ã‚’ç¢ºä¿ / ãƒãƒ³ã‚¬ãƒ¼ã‚’è²·ã†" />
          </div>
          <div>
            <label>Whyï¼ˆä½•ã®ãŸã‚ã«ï¼‰</label>
            <input id="why" type="text" placeholder="ä¾‹ï¼šæœã‚’æ¸…æ½”ã«ä¿ã¡ã€æœã®æº–å‚™ã‚’é€Ÿãã™ã‚‹" />
          </div>
        </div>
        <div class="stack">
          <div>
            <label>å ´æ‰€ãƒ»ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰</label>
            <input id="loc" type="text" placeholder="ä¾‹ï¼šæ´—é¢æ‰€ / ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ / ç„é–¢ / #å¤œã«ã‚„ã‚‹" />
          </div>
          <div>
            <label>Blocked byï¼ˆã“ã®é …ç›®ã‚’å®Œäº†ã™ã‚‹ãŸã‚ã«å¿…è¦ãªé …ç›®ï¼‰</label>
            <div id="blockedByBox" class="stack" style="max-height:140px;overflow:auto;border:1px solid rgba(148,163,184,.2);border-radius:12px;padding:8px"></div>
            <div class="hint">æ—¢å­˜ã®é …ç›®ã‹ã‚‰é¸æŠã€‚è¤‡æ•°å¯ã€‚</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn primary" id="addBtn">è¿½åŠ </button>
            <button class="btn" id="clearBtn">ã‚¯ãƒªã‚¢</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Next actions / Blocked / Resources -->
    <div class="grid cols-2 section">
      <div class="card">
        <div style="font-weight:800">ã„ã¾å‡ºæ¥ã‚‹æœ€å°ã®ä¸€æ‰‹ï¼ˆNext actionsï¼‰</div>
        <ul class="list" id="nextList"></ul>
      </div>
      <div class="card">
        <div style="font-weight:800">ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹é …ç›®ï¼ˆBlockedï¼‰</div>
        <ul class="list" id="blockedList"></ul>
      </div>
    </div>

    <div class="grid cols-2 section">
      <div class="card">
        <div style="font-weight:800">ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹</div>
        <ul class="list" id="resourceList"></ul>
        <div class="hint">ğŸ“¦ ãƒªã‚½ãƒ¼ã‚¹ã¯ã€Œå¿…è¦â†’ç¢ºä¿æ¸ˆã¿ã€ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã€‚è²·ã„ç‰©ãƒªã‚¹ãƒˆæŠ½å‡ºã«åˆ©ç”¨ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="card">
        <div style="font-weight:800">å…¨é …ç›®ï¼ˆç·¨é›†ï¼‰</div>
        <ul class="list" id="allList"></ul>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // State & Utilities
    // =========================
    const LS_KEY = 'choreDepsV1';
    const $ = s=>document.querySelector(s);
    const el = {
      blockedByBox: $('#blockedByBox'),
      nextList: $('#nextList'),
      blockedList: $('#blockedList'),
      resourceList: $('#resourceList'),
      allList: $('#allList'),
      kind: $('#kind'), title: $('#title'), why: $('#why'), loc: $('#loc'),
      addBtn: $('#addBtn'), clearBtn: $('#clearBtn'),
      templateLaundry: $('#templateLaundry'), templateCloset: $('#templateCloset'), templateHangers: $('#templateHangers'),
      annoyBtn: $('#annoyBtn'), toast: $('#toast'),
  runTestsBtn: $('#runTestsBtn'), testOutput: $('#testOutput'),
  resetBtn: $('#resetBtn'),
      startHereBtn: $('#startHereBtn')
    };

    function uuid(){return 'xxxxxxxyxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;const v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});}
    function load(){try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch{return[]}}
    function save(arr){localStorage.setItem(LS_KEY, JSON.stringify(arr));}

    function showToast(msg){el.toast.textContent = msg; el.toast.classList.add('show'); setTimeout(()=>el.toast.classList.remove('show'), 2600);}

    function optionFor(item){
      const lab = `${item.kind==='action'?'ğŸ§©':'ğŸ“¦'} ${item.title}`;
      const id = `blk_${item.id}`;
      return `<label class="pill"><input type="checkbox" id="${id}" value="${item.id}"> ${lab}</label>`;
    }

    function refreshBlockedChooser(){
      const all = load();
      el.blockedByBox.innerHTML = all.map(optionFor).join(' ');
    }

    function getCheckedBlocked(){
      const box = el.blockedByBox; const ids = [];
      box.querySelectorAll('input[type="checkbox"]').forEach(ch=>{ if(ch.checked) ids.push(ch.value); });
      return ids;
    }

    // =========================
    // CRUD
    // =========================
    function addItem(kind,title,why,loc,blockedBy){
      const all = load();
      all.push({ id: uuid(), kind, title, why, loc, blockedBy, status: kind==='resource'?'need':'todo', ts: Date.now() });
      save(all); render(); showToast('è¿½åŠ ã—ã¾ã—ãŸ');
    }

    function toggleStatus(id){
      const all = load();
      const i = all.findIndex(x=>x.id===id);
      if(i<0) return; const it = all[i];
      if(it.kind==='action') it.status = (it.status==='todo')?'done':'todo';
      else it.status = (it.status==='need')?'have':'need';
      all[i]=it; save(all); render();
    }

    function removeItem(id){
      const all = load().filter(x=>x.id!==id);
      // ä¾å­˜ã—ã¦ã„ãŸblockedByã‹ã‚‰ã‚‚å¤–ã™
      all.forEach(x=>{x.blockedBy = (x.blockedBy||[]).filter(b=>b!==id);});
      save(all); render();
    }

    // =========================
    // Dependency & Query
    // =========================
    function isUnblocked(item, all){
      const deps = item.blockedBy||[];
      if(deps.length===0) return true;
      return deps.every(did=>{
        const dep = all.find(x=>x.id===did);
        if(!dep) return true; // å­˜åœ¨ã—ãªã‘ã‚Œã°ç„¡è¦–
        if(dep.kind==='action') return dep.status==='done';
        if(dep.kind==='resource') return dep.status==='have';
        return true;
      });
    }

    // =========================
    // Renderers
    // =========================
    function row(it, extra='', withDelete=false){
      const badge = `<span class="badge ${it.kind==='action'?'b-action':'b-resource'}">${it.kind==='action'?'ğŸ§© ã‚¢ã‚¯ã‚·ãƒ§ãƒ³':'ğŸ“¦ ãƒªã‚½ãƒ¼ã‚¹'}</span>`;
      const why = it.why?`<div class="why">Why: ${escapeHtml(it.why)}</div>`:'';
      const delBtn = withDelete ? `<button class="btn danger" onclick="removeItem('${it.id}')">å‰Šé™¤</button>` : '';
      return `<li class="row">
        ${badge}
        <div>
          <div>${escapeHtml(it.title)} ${it.loc?`<span class="pill">${escapeHtml(it.loc)}</span>`:''}</div>
          ${why}
          ${extra?`<div class="mini">${extra}</div>`:''}
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn" onclick="toggleStatus('${it.id}')">åˆ‡æ›¿</button>
          ${delBtn}
        </div>
      </li>`;
    }

    function render(){
      refreshBlockedChooser();
      const all = load();
      // Next actions
      const next = all.filter(x=>x.kind==='action' && x.status==='todo' && isUnblocked(x,all))
                      .sort((a,b)=>a.ts-b.ts);
      el.nextList.innerHTML = next.map(row).join('');

      // Blocked actions
      const blocked = all.filter(x=>x.kind==='action' && x.status==='todo' && !isUnblocked(x,all));
      el.blockedList.innerHTML = blocked.map(x=>{
        const req = (x.blockedBy||[]).map(id=>{
          const d = all.find(z=>z.id===id); if(!d) return ''; const needed = d.kind==='action'?(d.status!=='done'):(d.status!=='have');
          return needed?`<span class="pill">${d.kind==='action'?'ğŸ§©':'ğŸ“¦'} ${d.title}</span>`:'';
        }).filter(Boolean).join(' ');
        return row(x, req?`å¿…è¦: ${req}`:'');
      }).join('');

      // Resources
      const resources = all.filter(x=>x.kind==='resource').sort((a,b)=>a.status.localeCompare(b.status));
      el.resourceList.innerHTML = resources.map(row).join('');

      // All (with delete ops)
      el.allList.innerHTML = all.sort((a,b)=>a.ts-b.ts).map(it=>row(it, '', true)).join('');
    }

    // =========================
    // Helpers
    // =========================
    function escapeHtml(s){return (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

    function addFromForm(){
      const kind = el.kind.value;
      const title = el.title.value.trim(); if(!title) { showToast('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™'); return; }
      const why = el.why.value.trim();
      const loc = el.loc.value.trim();
      const blockedBy = getCheckedBlocked();
      addItem(kind,title,why,loc,blockedBy);
      clearForm();
    }

    function clearForm(){ el.title.value=''; el.why.value=''; el.loc.value=''; el.blockedByBox.querySelectorAll('input').forEach(i=>i.checked=false); }

    // =========================
    // Reset (Initialize Screen/Data)
    // =========================
    function resetAll(){
      try{ localStorage.removeItem(LS_KEY); }catch{}
      clearForm();
      refreshBlockedChooser();
      render();
      if(el.testOutput){ el.testOutput.style.display='none'; el.testOutput.textContent=''; }
      showToast('åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    }

    // =========================
    // Templates matching your examples
    // =========================
    function addLaundryTemplate(){
      const ids = {};
      function add(k,t,w,l,blk){ const all=load(); const it={ id:uuid(), kind:k, title:t, why:w, loc:l, blockedBy:blk||[], status:k==='resource'?'need':'todo', ts:Date.now() }; all.push(it); save(all); return it.id; }

      ids.hangers = add('resource','ãƒãƒ³ã‚¬ãƒ¼ãŒã‚ã‚‹','æœã‚’å¹²ã™æº–å‚™','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ');
      ids.drySpace = add('resource','ä¹¾ã‹ã™å ´æ‰€ãŒã‚ã‚‹','å®¤å†…å¹²ã—orãƒ™ãƒ©ãƒ³ãƒ€ã®ç¢ºä¿','æ´—é¢æ‰€');
      ids.closetSpace = add('resource','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆã«ä»•èˆã†å ´æ‰€ãŒã‚ã‚‹','è¡£é¡ã‚’ç´ æ—©ãç‰‡ä»˜ã‘ã‚‹','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ');

      ids.takeInDry = add('action','ä¹¾ã„ãŸæ´—æ¿¯ç‰©ã‚’å–ã‚Šè¾¼ã‚€','å¹²ã—å ´æ‰€ã‚’ç©ºã‘ã‚‹','ãƒ™ãƒ©ãƒ³ãƒ€');
      updateDeps(ids.drySpace,[ids.takeInDry, ids.hangers]);

      ids.organizeCloset = add('action','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆã‚’ç‰‡ä»˜ã‘ã‚‹','ä»•èˆã†å‹•ç·šã‚’ä½œã‚‹','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ');
      updateDeps(ids.closetSpace,[ids.organizeCloset]);

      ids.buyHangers = add('action','ãƒãƒ³ã‚¬ãƒ¼ã‚’è²·ã†','å¹²ã™/åç´ã®åŠ¹ç‡åŒ–','#è²·ã„ç‰©');
      updateDeps(ids.hangers,[ids.buyHangers]);

      ids.doLaundry = add('action','æ´—æ¿¯ã™ã‚‹','æ¸…æ½”ã«ä¿ã¤','æ´—é¢æ‰€',[ids.drySpace]);

      ids.fold = add('action','æ´—æ¿¯ç‰©ã‚’ç•³ã‚€','æ•£ã‚‰ã‹ã‚Šé˜²æ­¢','ãƒªãƒ“ãƒ³ã‚°',[ids.doLaundry]);
      ids.putAway = add('action','æ´—æ¿¯ç‰©ã‚’ä»•èˆã†','éƒ¨å±‹ã‚’æ•´ãˆã‚‹','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ',[ids.fold, ids.closetSpace]);

      render(); showToast('æ´—æ¿¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    function addClosetTemplate(){
      const ids={};
      function add(k,t,w,l,blk){ const all=load(); const it={ id:uuid(), kind:k, title:t, why:w, loc:l, blockedBy:blk||[], status:k==='resource'?'need':'todo', ts:Date.now() }; all.push(it); save(all); return it.id; }
      ids.bin=add('resource','ä¸è¦å“ã‚’å…¥ã‚Œã‚‹ç®±ãŒã‚ã‚‹','ä»•åˆ†ã‘ã‚’æ—©ãã™ã‚‹','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ');
      ids.trash=add('resource','ã‚´ãƒŸè¢‹ãŒã‚ã‚‹','å³æ™‚ã«å»ƒæ£„ã§ãã‚‹','#æ¶ˆè€—å“');
      ids.space=add('resource','åºŠã®ä½œæ¥­ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚‹','ä»•åˆ†ã‘ã®åŠ¹ç‡åŒ–','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ');
      ids.clearFloor=add('action','åºŠã‚’ä¸€æ™‚çš„ã«ç©ºã‘ã‚‹','ä½œæ¥­ã‚¹ãƒšãƒ¼ã‚¹ã®ç¢ºä¿','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ');
      updateDeps(ids.space,[ids.clearFloor]);
      ids.sort=add('action','æœã‚’ã€Œæ®‹ã™/æ¨ã¦ã‚‹/ä¿ç•™ã€ã«ä»•åˆ†ã‘','åç´ã®æœ€é©åŒ–','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ',[ids.bin, ids.trash, ids.space]);
      ids.organize=add('action','æ®‹ã™æœã‚’åç´ã«æˆ»ã™','å–ã‚Šå‡ºã—ã‚„ã™ã•å‘ä¸Š','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ',[ids.sort]);
      render(); showToast('ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆæ•´é “ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    function addHangersTemplate(){
      const ids={};
      function add(k,t,w,l,blk){ const all=load(); const it={ id:uuid(), kind:k, title:t, why:w, loc:l, blockedBy:blk||[], status:k==='resource'?'need':'todo', ts:Date.now() }; all.push(it); save(all); return it.id; }
      ids.buy=add('action','ãƒãƒ³ã‚¬ãƒ¼ã‚’è²·ã†','å¹²ã—ã¨åç´ã®åŠ¹ç‡åŒ–','#è²·ã„ç‰©');
      ids.have=add('resource','ãƒãƒ³ã‚¬ãƒ¼ãŒã‚ã‚‹','æ´—æ¿¯/åç´ã®åŠ¹ç‡åŒ–','ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ',[ids.buy]);
      render(); showToast('ãƒãƒ³ã‚¬ãƒ¼ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    function updateDeps(id, deps){
      const all=load(); const i=all.findIndex(x=>x.id===id); if(i<0) return; all[i].blockedBy=[...(all[i].blockedBy||[]), ...deps]; save(all);
    }

    // =========================
    // Encouragement & Bindings
    // =========================
    function onAnnoy(){
      const msgs=[
        'OKã€æœ€å°ã®ä¸€æ‰‹ã ã‘ã‚„ã‚ã†ï¼ˆ30ç§’ãƒ«ãƒ¼ãƒ«ï¼‰',
        'æœªæ¥ã®è‡ªåˆ†ã®ãŸã‚ã«1ãƒã‚§ãƒƒã‚¯ã ã‘',
        'ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’1ã¤è§£é™¤ï¼å…¨ä½“ãŒè»½ããªã‚‹ã‚ˆ',
        'æ·±å‘¼å¸â†’æ°´ä¸€å£â†’æœ€å°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',
        'ã€Œå®Œç’§ã€ã‚ˆã‚Šã€Œé€²æ—ã€ï¼'];
      showToast(msgs[Math.floor(Math.random()*msgs.length)]);
    }

    function bind(){
      el.addBtn.addEventListener('click', addFromForm);
      el.clearBtn.addEventListener('click', clearForm);
      el.templateLaundry.addEventListener('click', addLaundryTemplate);
      el.templateCloset.addEventListener('click', addClosetTemplate);
      el.templateHangers.addEventListener('click', addHangersTemplate);
      el.annoyBtn.addEventListener('click', onAnnoy);
      el.runTestsBtn.addEventListener('click', runSelfTests);
  if(el.resetBtn) el.resetBtn.addEventListener('click', resetAll);
    }

    function init(){ refreshBlockedChooser(); bind(); render(); }
    document.addEventListener('DOMContentLoaded', init);

    // =========================
    // Minimal Self Tests (console + UI)
    // =========================
    function runSelfTests(){
      const logs=[]; let pass=0, fail=0; const T=(name,fn)=>{try{fn(); pass++; logs.push(`âœ… ${name}`);}catch(e){fail++; logs.push(`âŒ ${name}: ${e.message}`);}};

      // Test 1: isUnblocked with no deps
      T('no deps â†’ unblocked', ()=>{
        const it={kind:'action',status:'todo',blockedBy:[]};
        if(!isUnblocked(it,[])) throw new Error('expected true');
      });

      // Test 2: blocked by resource not have
      T('blocked by resource (need) â†’ blocked', ()=>{
        const res={id:'r1',kind:'resource',status:'need'}; const it={kind:'action',status:'todo',blockedBy:['r1']};
        if(isUnblocked(it,[res])) throw new Error('expected false');
      });

      // Test 3: unblocked when resource have
      T('resource have â†’ unblocked', ()=>{
        const res={id:'r1',kind:'resource',status:'have'}; const it={kind:'action',status:'todo',blockedBy:['r1']};
        if(!isUnblocked(it,[res])) throw new Error('expected true');
      });

      // Test 4: blocked by action not done
      T('blocked by action (todo) â†’ blocked', ()=>{
        const act={id:'a1',kind:'action',status:'todo'}; const it={kind:'action',status:'todo',blockedBy:['a1']};
        if(isUnblocked(it,[act])) throw new Error('expected false');
      });

      // Test 5: action done â†’ unblocked
      T('action done â†’ unblocked', ()=>{
        const act={id:'a1',kind:'action',status:'done'}; const it={kind:'action',status:'todo',blockedBy:['a1']};
        if(!isUnblocked(it,[act])) throw new Error('expected true');
      });

      // Test 6: escapeHtml
      T('escapeHtml', ()=>{
        const s=escapeHtml('<div>"&"</div>');
        if(s !== '&lt;div&gt;&quot;&amp;&quot;&lt;/div&gt;') throw new Error('escape failed');
      });

      const summary = `Tests: ${pass+fail}  Passed: ${pass}  Failed: ${fail}`;
      console.log(summary); logs.unshift(summary);
      el.testOutput.style.display = 'block';
      el.testOutput.textContent = logs.join('\n');
      showToast(fail===0? 'ãƒ†ã‚¹ãƒˆå…¨é€šé âœ…' : 'ãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™ âŒ');
    }
  </script>
</body>
</html>
